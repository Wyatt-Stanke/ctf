<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CTF Challenge: {{TITLE}}</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link
      href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;700&family=Source+Serif+4:ital,wght@0,400;0,600;1,400&display=swap"
      rel="stylesheet"
    />
    <style>
      /* ── Shared base ── */
      {{SHARED_CSS}}

      /* ── Challenge-page-specific styles ── */
      .container {
        max-width: 680px;
        width: 100%;
      }

      /* Back button */
      .back-link {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        font-family: "JetBrains Mono", monospace;
        font-size: 12px;
        color: var(--text-dim);
        text-decoration: none;
        margin-bottom: 24px;
        transition: color 0.15s;
      }

      .back-link:hover {
        color: var(--accent);
      }

      .back-link svg {
        width: 14px;
        height: 14px;
        fill: currentColor;
      }

      /* Status badge */
      .status-bar {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 20px;
      }

      .status-badge {
        font-family: "JetBrains Mono", monospace;
        font-size: 11px;
        font-weight: 700;
        letter-spacing: 1px;
        text-transform: uppercase;
        padding: 4px 12px;
        border-radius: 3px;
      }

      .status-badge.solved {
        color: var(--green);
        background: #22c55e22;
      }

      .status-badge.unsolved {
        color: var(--text-dim);
        background: var(--surface-2);
      }

      /* Briefing */
      .briefing {
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 32px;
        margin-bottom: 32px;
      }

      .briefing p {
        font-size: 17px;
        margin-bottom: 16px;
      }

      .briefing p:last-child {
        margin-bottom: 0;
      }

      /* Notes */
      .notes {
        background: var(--surface-2);
        border-left: 3px solid var(--accent);
        border-radius: 6px;
        padding: 20px 24px;
        margin-bottom: 32px;
      }

      .notes-title {
        font-family: "JetBrains Mono", monospace;
        font-size: 12px;
        font-weight: 700;
        letter-spacing: 1.5px;
        text-transform: uppercase;
        color: var(--accent);
        margin-bottom: 10px;
      }

      .notes p {
        font-size: 15px;
        color: var(--text);
        line-height: 1.6;
      }

      .flag-format {
        font-family: "JetBrains Mono", monospace;
        font-size: 13px;
        color: var(--text-dim);
        background: var(--surface-2);
        padding: 8px 14px;
        border-radius: 4px;
        display: inline-block;
        margin-top: 8px;
      }

      /* Target link */
      .target-link {
        display: block;
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 20px 28px;
        margin-bottom: 40px;
        text-decoration: none;
        transition:
          border-color 0.2s,
          box-shadow 0.2s;
      }

      .target-link:hover {
        border-color: var(--accent);
        box-shadow: 0 0 20px var(--accent-glow);
      }

      .target-label {
        font-family: "JetBrains Mono", monospace;
        font-size: 11px;
        letter-spacing: 2px;
        text-transform: uppercase;
        color: var(--text-dim);
        margin-bottom: 6px;
      }

      .target-url {
        font-family: "JetBrains Mono", monospace;
        font-size: 15px;
        color: var(--accent);
      }

      /* Hints */
      .hints-section h2 {
        font-family: "JetBrains Mono", monospace;
        font-size: 14px;
        font-weight: 500;
        letter-spacing: 1px;
        text-transform: uppercase;
        color: var(--text-dim);
        margin-bottom: 16px;
      }

      .hint {
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: 8px;
        margin-bottom: 12px;
        overflow: hidden;
      }

      .hint-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 16px 24px;
        cursor: pointer;
        user-select: none;
        transition: background 0.15s;
      }

      .hint-header:hover {
        background: var(--surface-2);
      }

      .hint-title {
        font-family: "JetBrains Mono", monospace;
        font-size: 14px;
        font-weight: 500;
        color: #f0f2f6;
      }

      .hint-toggle {
        font-family: "JetBrains Mono", monospace;
        font-size: 12px;
        color: var(--yellow);
        background: none;
        border: 1px solid var(--yellow);
        border-radius: 4px;
        padding: 3px 10px;
        cursor: pointer;
        transition:
          background 0.15s,
          color 0.15s;
        flex-shrink: 0;
        margin-left: 16px;
      }

      .hint-toggle:hover {
        background: var(--yellow);
        color: var(--bg);
      }

      .hint-body {
        max-height: 0;
        overflow: hidden;
        transition:
          max-height 0.35s ease,
          padding 0.35s ease;
      }

      .hint-body.revealed {
        max-height: 300px;
      }

      .hint-body-inner {
        padding: 0 24px 20px 24px;
        font-size: 16px;
        font-style: italic;
        color: var(--yellow);
        opacity: 0.9;
      }

      .warning {
        font-family: "JetBrains Mono", monospace;
        font-size: 11px;
        color: var(--text-dim);
        text-align: center;
        margin-top: 32px;
        opacity: 0.5;
      }

      .inline-code {
        font-family: "JetBrains Mono", monospace;
        font-size: 13px;
        background: var(--surface);
        padding: 2px 6px;
        border-radius: 3px;
      }

      blockquote {
        border-left: 3px solid var(--accent);
        padding-left: 16px;
        margin: 16px 0;
        color: var(--text-dim);
        font-style: italic;
      }

      /* Flag submission (challenge-page sizing) */
      .flag-section {
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 24px 28px;
        margin-top: 40px;
        margin-bottom: 16px;
      }

      .flag-section-title {
        font-family: "JetBrains Mono", monospace;
        font-size: 14px;
        font-weight: 700;
        color: #f0f2f6;
        margin-bottom: 14px;
      }

      .flag-input {
        padding: 10px 14px;
        flex: 1;
      }

      .flag-btn {
        font-size: 13px;
        padding: 10px 20px;
        flex-shrink: 0;
      }

      .flag-result {
        font-size: 13px;
        min-height: 20px;
        margin-top: 10px;
      }

      @media (max-width: 600px) {
        .flag-form {
          flex-direction: column;
        }
        .flag-input {
          width: 100%;
        }
      }
    </style>
  </head>
  <body>
    <canvas class="confetti-canvas" id="confettiCanvas"></canvas>

    <div class="container">
      <a class="back-link" href="../../">
        <svg viewBox="0 0 16 16">
          <path
            d="M7.78 12.53a.75.75 0 01-1.06 0L2.47 8.28a.75.75 0 010-1.06l4.25-4.25a.75.75 0 011.06 1.06L4.81 7h7.44a.75.75 0 010 1.5H4.81l2.97 2.97a.75.75 0 010 1.06z"
          />
        </svg>
        All challenges
      </a>

      <div class="status-bar">
        <span
          class="difficulty"
          style="color:{{DIFF_COLOR}};background:{{DIFF_COLOR}}22"
          >{{DIFFICULTY}}</span
        >
        <span class="status-badge unsolved" id="statusBadge">Not solved</span>
      </div>

      <h1>{{TITLE}}</h1>

      {{BODY}}

      <!-- Flag submission -->
      <div class="flag-section" id="flagSection">
        <div class="flag-section-title">Submit Flag</div>
        <form class="flag-form" onsubmit="return _checkFlag(event);">
          <input
            type="text"
            class="flag-input"
            id="flagInput"
            placeholder="flag{...}"
            autocomplete="off"
            spellcheck="false"
          />
          <button type="submit" class="flag-btn">Submit</button>
        </form>
        <div class="flag-result" id="flagResult"></div>
      </div>
    </div>

    <script>
      /* ── Shared helpers ── */
      {{SHARED_JS}}

      /* ── Challenge-page-specific logic ── */
      const SLUG = "{{SLUG}}";
      const FLAG_HASH = "{{FLAG_HASH}}";

      /* Status */
      function _updateStatus() {
        const solved = _getSolved();
        const badge = document.getElementById("statusBadge");
        if (solved[SLUG]) {
          badge.className = "status-badge solved";
          badge.textContent = "\u2713 Solved";
          const result = document.getElementById("flagResult");
          if (result && !result.textContent) {
            result.className = "flag-result correct";
            result.innerHTML =
              '<span class="solved-badge flag-pop">\u2713 Solved</span>';
          }
        }
      }

      /* Flag checking */
      async function _checkFlag(e) {
        e.preventDefault();
        const input = document.getElementById("flagInput");
        const resultEl = document.getElementById("flagResult");
        const value = input.value.trim();

        if (!value) return false;

        if (!FLAG_HASH) {
          resultEl.className = "flag-result incorrect";
          resultEl.textContent = "No hash configured for this challenge.";
          return false;
        }

        const hash = await _sha256(value);

        if (hash === FLAG_HASH) {
          const section = document.getElementById("flagSection");
          resultEl.className = "flag-result correct";
          resultEl.innerHTML =
            '<span class="solved-badge flag-pop">\u2713 Correct!</span>';

          if (section) {
            section.classList.add("celebrate");
            _confetti.burst(section);
            setTimeout(() => section.classList.remove("celebrate"), 800);
          }

          _setSolved(SLUG);
          _updateStatus();
        } else {
          resultEl.className = "flag-result incorrect";
          resultEl.textContent = "Incorrect flag. Try again.";
          input.classList.add("shake");
          setTimeout(() => input.classList.remove("shake"), 400);
        }

        return false;
      }

      /* Hint toggle */
      function _toggleHint(header) {
        const body = header.nextElementSibling;
        const btn = header.querySelector(".hint-toggle");
        const isRevealed = body.classList.contains("revealed");

        if (!isRevealed) {
          if (!body.dataset.confirmed) {
            btn.textContent = "Sure?";
            body.dataset.confirmed = "pending";
            return;
          }
          if (body.dataset.confirmed === "pending") {
            btn.textContent = "Really sure?";
            body.dataset.confirmed = "confirm-again";
            return;
          }
          body.classList.add("revealed");
          btn.textContent = "Hide";
          body.dataset.confirmed = "done";
        } else {
          body.classList.remove("revealed");
          btn.textContent = "Reveal";
          delete body.dataset.confirmed;
        }
      }

      // Init
      _updateStatus();
    </script>
  </body>
</html>
