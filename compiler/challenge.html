<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CTF Challenge: {{TITLE}}</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link
      href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;700&family=Source+Serif+4:ital,wght@0,400;0,600;1,400&display=swap"
      rel="stylesheet"
    />
    <style>
      *,
      *::before,
      *::after {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      :root {
        --bg: #0c0e13;
        --surface: #13161d;
        --surface-2: #1a1e27;
        --border: #2a2f3a;
        --text: #c8cdd8;
        --text-dim: #6b7280;
        --accent: #e05a33;
        --accent-glow: #e05a3344;
        --green: #22c55e;
        --red: #ef4444;
        --yellow: #fbbf24;
      }

      body {
        font-family: "Source Serif 4", Georgia, serif;
        background: var(--bg);
        color: var(--text);
        min-height: 100vh;
        display: flex;
        justify-content: center;
        padding: 60px 20px;
        line-height: 1.7;
        overflow-x: hidden;
      }

      .container {
        max-width: 680px;
        width: 100%;
      }

      /* ── Back button ── */
      .back-link {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        font-family: "JetBrains Mono", monospace;
        font-size: 12px;
        color: var(--text-dim);
        text-decoration: none;
        margin-bottom: 24px;
        transition: color 0.15s;
      }

      .back-link:hover {
        color: var(--accent);
      }

      .back-link svg {
        width: 14px;
        height: 14px;
        fill: currentColor;
      }

      /* ── Status badge ── */
      .status-bar {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 20px;
      }

      .difficulty {
        display: inline-block;
        font-family: "JetBrains Mono", monospace;
        font-size: 11px;
        font-weight: 700;
        letter-spacing: 2px;
        text-transform: uppercase;
        padding: 4px 12px;
        border-radius: 3px;
      }

      .status-badge {
        font-family: "JetBrains Mono", monospace;
        font-size: 11px;
        font-weight: 700;
        letter-spacing: 1px;
        text-transform: uppercase;
        padding: 4px 12px;
        border-radius: 3px;
      }

      .status-badge.solved {
        color: var(--green);
        background: #22c55e22;
      }

      .status-badge.unsolved {
        color: var(--text-dim);
        background: var(--surface-2);
      }

      h1 {
        font-family: "JetBrains Mono", monospace;
        font-size: 28px;
        font-weight: 700;
        color: #f0f2f6;
        margin-bottom: 8px;
        line-height: 1.3;
      }

      /* ── Briefing ── */
      .briefing {
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 32px;
        margin-bottom: 32px;
      }

      .briefing p {
        font-size: 17px;
        margin-bottom: 16px;
      }

      .briefing p:last-child {
        margin-bottom: 0;
      }

      /* ── Notes ── */
      .notes {
        background: var(--surface-2);
        border-left: 3px solid var(--accent);
        border-radius: 6px;
        padding: 20px 24px;
        margin-bottom: 32px;
      }

      .notes-title {
        font-family: "JetBrains Mono", monospace;
        font-size: 12px;
        font-weight: 700;
        letter-spacing: 1.5px;
        text-transform: uppercase;
        color: var(--accent);
        margin-bottom: 10px;
      }

      .notes p {
        font-size: 15px;
        color: var(--text);
        line-height: 1.6;
      }

      .flag-format {
        font-family: "JetBrains Mono", monospace;
        font-size: 13px;
        color: var(--text-dim);
        background: var(--surface-2);
        padding: 8px 14px;
        border-radius: 4px;
        display: inline-block;
        margin-top: 8px;
      }

      /* ── Target link ── */
      .target-link {
        display: block;
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 20px 28px;
        margin-bottom: 40px;
        text-decoration: none;
        transition:
          border-color 0.2s,
          box-shadow 0.2s;
      }

      .target-link:hover {
        border-color: var(--accent);
        box-shadow: 0 0 20px var(--accent-glow);
      }

      .target-label {
        font-family: "JetBrains Mono", monospace;
        font-size: 11px;
        letter-spacing: 2px;
        text-transform: uppercase;
        color: var(--text-dim);
        margin-bottom: 6px;
      }

      .target-url {
        font-family: "JetBrains Mono", monospace;
        font-size: 15px;
        color: var(--accent);
      }

      /* ── Hints ── */
      .hints-section h2 {
        font-family: "JetBrains Mono", monospace;
        font-size: 14px;
        font-weight: 500;
        letter-spacing: 1px;
        text-transform: uppercase;
        color: var(--text-dim);
        margin-bottom: 16px;
      }

      .hint {
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: 8px;
        margin-bottom: 12px;
        overflow: hidden;
      }

      .hint-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 16px 24px;
        cursor: pointer;
        user-select: none;
        transition: background 0.15s;
      }

      .hint-header:hover {
        background: var(--surface-2);
      }

      .hint-title {
        font-family: "JetBrains Mono", monospace;
        font-size: 14px;
        font-weight: 500;
        color: #f0f2f6;
      }

      .hint-toggle {
        font-family: "JetBrains Mono", monospace;
        font-size: 12px;
        color: var(--yellow);
        background: none;
        border: 1px solid var(--yellow);
        border-radius: 4px;
        padding: 3px 10px;
        cursor: pointer;
        transition:
          background 0.15s,
          color 0.15s;
        flex-shrink: 0;
        margin-left: 16px;
      }

      .hint-toggle:hover {
        background: var(--yellow);
        color: var(--bg);
      }

      .hint-body {
        max-height: 0;
        overflow: hidden;
        transition:
          max-height 0.35s ease,
          padding 0.35s ease;
      }

      .hint-body.revealed {
        max-height: 300px;
      }

      .hint-body-inner {
        padding: 0 24px 20px 24px;
        font-size: 16px;
        font-style: italic;
        color: var(--yellow);
        opacity: 0.9;
      }

      .warning {
        font-family: "JetBrains Mono", monospace;
        font-size: 11px;
        color: var(--text-dim);
        text-align: center;
        margin-top: 32px;
        opacity: 0.5;
      }

      .inline-code {
        font-family: "JetBrains Mono", monospace;
        font-size: 13px;
        background: var(--surface);
        padding: 2px 6px;
        border-radius: 3px;
      }

      blockquote {
        border-left: 3px solid var(--accent);
        padding-left: 16px;
        margin: 16px 0;
        color: var(--text-dim);
        font-style: italic;
      }

      /* ── Flag submission ── */
      .flag-section {
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 24px 28px;
        margin-top: 40px;
        margin-bottom: 16px;
      }

      .flag-section-title {
        font-family: "JetBrains Mono", monospace;
        font-size: 14px;
        font-weight: 700;
        color: #f0f2f6;
        margin-bottom: 14px;
      }

      .flag-form {
        display: flex;
        gap: 8px;
        align-items: center;
      }

      .flag-input {
        font-family: "JetBrains Mono", monospace;
        font-size: 13px;
        background: var(--surface-2);
        border: 1px solid var(--border);
        border-radius: 4px;
        color: var(--text);
        padding: 10px 14px;
        flex: 1;
        outline: none;
        transition: border-color 0.15s;
      }

      .flag-input:focus {
        border-color: var(--accent);
      }

      .flag-btn {
        font-family: "JetBrains Mono", monospace;
        font-size: 13px;
        font-weight: 700;
        color: #f0f2f6;
        background: var(--accent);
        border: none;
        border-radius: 4px;
        padding: 10px 20px;
        cursor: pointer;
        transition: opacity 0.15s;
        flex-shrink: 0;
      }

      .flag-btn:hover {
        opacity: 0.85;
      }

      .flag-result {
        font-family: "JetBrains Mono", monospace;
        font-size: 13px;
        min-height: 20px;
        margin-top: 10px;
      }

      .flag-result.correct {
        color: var(--green);
      }

      .flag-result.incorrect {
        color: var(--red);
      }

      .solved-badge {
        font-family: "JetBrains Mono", monospace;
        font-size: 11px;
        font-weight: 700;
        letter-spacing: 1px;
        text-transform: uppercase;
        color: var(--green);
        background: #22c55e22;
        padding: 3px 10px;
        border-radius: 3px;
      }

      /* ── Confetti ── */
      .confetti-canvas {
        position: fixed;
        inset: 0;
        pointer-events: none;
        z-index: 999;
      }

      @keyframes shake {
        0%,
        100% {
          transform: translateX(0);
        }
        20%,
        60% {
          transform: translateX(-4px);
        }
        40%,
        80% {
          transform: translateX(4px);
        }
      }
      .shake {
        animation: shake 0.3s ease;
      }

      @keyframes celebrate-glow {
        0% {
          box-shadow: 0 0 0px transparent;
        }
        30% {
          box-shadow:
            0 0 30px #22c55e55,
            0 0 60px #22c55e22;
        }
        100% {
          box-shadow: 0 0 20px #22c55e22;
        }
      }

      @keyframes flag-pop {
        0% {
          transform: scale(0.8);
          opacity: 0;
        }
        50% {
          transform: scale(1.15);
        }
        100% {
          transform: scale(1);
          opacity: 1;
        }
      }

      .celebrate {
        animation: celebrate-glow 0.8s ease forwards;
      }
      .flag-pop {
        animation: flag-pop 0.5s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
      }

      @media (max-width: 600px) {
        .flag-form {
          flex-direction: column;
        }
        .flag-input {
          width: 100%;
        }
      }
    </style>
  </head>
  <body>
    <canvas class="confetti-canvas" id="confettiCanvas"></canvas>

    <div class="container">
      <a class="back-link" href="../">
        <svg viewBox="0 0 16 16">
          <path
            d="M7.78 12.53a.75.75 0 01-1.06 0L2.47 8.28a.75.75 0 010-1.06l4.25-4.25a.75.75 0 011.06 1.06L4.81 7h7.44a.75.75 0 010 1.5H4.81l2.97 2.97a.75.75 0 010 1.06z"
          />
        </svg>
        All challenges
      </a>

      <div class="status-bar">
        <span
          class="difficulty"
          style="color:{{DIFF_COLOR}};background:{{DIFF_COLOR}}22"
          >{{DIFFICULTY}}</span
        >
        <span class="status-badge unsolved" id="statusBadge">Not solved</span>
      </div>

      <h1>{{TITLE}}</h1>

      {{BODY}}

      <!-- Flag submission -->
      <div class="flag-section" id="flagSection">
        <div class="flag-section-title">Submit Flag</div>
        <form class="flag-form" onsubmit="return _checkFlag(event);">
          <input
            type="text"
            class="flag-input"
            id="flagInput"
            placeholder="flag{...}"
            autocomplete="off"
            spellcheck="false"
          />
          <button type="submit" class="flag-btn">Submit</button>
        </form>
        <div class="flag-result" id="flagResult"></div>
      </div>
    </div>

    <script>
      const SLUG = "{{SLUG}}";
      const FLAG_HASH = "{{FLAG_HASH}}";

      /* ── localStorage helpers (shared format with homepage) ── */
      function _getSolved() {
        try {
          return JSON.parse(localStorage.getItem("ctf_solved") || "{}");
        } catch {
          return {};
        }
      }

      function _setSolved(slug) {
        const s = _getSolved();
        s[slug] = true;
        localStorage.setItem("ctf_solved", JSON.stringify(s));
      }

      /* ── Status ── */
      function _updateStatus() {
        const solved = _getSolved();
        const badge = document.getElementById("statusBadge");
        const section = document.getElementById("flagSection");
        if (solved[SLUG]) {
          badge.className = "status-badge solved";
          badge.textContent = "\u2713 Solved";
          const result = document.getElementById("flagResult");
          if (result && !result.textContent) {
            result.className = "flag-result correct";
            result.innerHTML =
              '<span class="solved-badge flag-pop">\u2713 Solved</span>';
          }
        }
      }

      /* ── SHA-256 ── */
      async function _sha256(str) {
        const buf = new TextEncoder().encode(str);
        const hash = await crypto.subtle.digest("SHA-256", buf);
        return Array.from(new Uint8Array(hash))
          .map((b) => b.toString(16).padStart(2, "0"))
          .join("");
      }

      /* ── Confetti engine ── */
      const _confetti = (() => {
        const canvas = document.getElementById("confettiCanvas");
        const ctx = canvas.getContext("2d");
        let particles = [];
        let running = false;

        function resize() {
          canvas.width = window.innerWidth;
          canvas.height = window.innerHeight;
        }
        window.addEventListener("resize", resize);
        resize();

        const COLORS = [
          "#22c55e",
          "#e05a33",
          "#fbbf24",
          "#a855f7",
          "#3b82f6",
          "#ec4899",
          "#f0f2f6",
        ];

        function spawn(x, y, count) {
          for (let i = 0; i < count; i++) {
            const angle = Math.random() * Math.PI * 2;
            const speed = 4 + Math.random() * 8;
            particles.push({
              x,
              y,
              vx: Math.cos(angle) * speed,
              vy: Math.sin(angle) * speed - 4,
              size: 4 + Math.random() * 6,
              color: COLORS[Math.floor(Math.random() * COLORS.length)],
              rotation: Math.random() * 360,
              rotSpeed: (Math.random() - 0.5) * 12,
              life: 1,
              decay: 0.008 + Math.random() * 0.012,
              shape: Math.random() > 0.5 ? "rect" : "circle",
            });
          }
          if (!running) {
            running = true;
            loop();
          }
        }

        function loop() {
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          for (let i = particles.length - 1; i >= 0; i--) {
            const p = particles[i];
            p.x += p.vx;
            p.y += p.vy;
            p.vy += 0.18;
            p.vx *= 0.99;
            p.rotation += p.rotSpeed;
            p.life -= p.decay;
            if (p.life <= 0) {
              particles.splice(i, 1);
              continue;
            }

            ctx.save();
            ctx.translate(p.x, p.y);
            ctx.rotate((p.rotation * Math.PI) / 180);
            ctx.globalAlpha = p.life;
            ctx.fillStyle = p.color;
            if (p.shape === "rect") {
              ctx.fillRect(-p.size / 2, -p.size / 2, p.size, p.size * 0.6);
            } else {
              ctx.beginPath();
              ctx.arc(0, 0, p.size / 2, 0, Math.PI * 2);
              ctx.fill();
            }
            ctx.restore();
          }
          if (particles.length > 0) {
            requestAnimationFrame(loop);
          } else {
            running = false;
          }
        }

        return {
          burst(el) {
            const rect = el.getBoundingClientRect();
            const cx = rect.left + rect.width / 2;
            const cy = rect.top + rect.height / 2;
            spawn(cx, cy, 60);
            setTimeout(() => spawn(cx - 60, cy - 20, 30), 100);
            setTimeout(() => spawn(cx + 60, cy - 20, 30), 200);
          },
        };
      })();

      /* ── Flag checking ── */
      async function _checkFlag(e) {
        e.preventDefault();
        const input = document.getElementById("flagInput");
        const resultEl = document.getElementById("flagResult");
        const value = input.value.trim();

        if (!value) return false;

        if (!FLAG_HASH) {
          resultEl.className = "flag-result incorrect";
          resultEl.textContent = "No hash configured for this challenge.";
          return false;
        }

        const hash = await _sha256(value);

        if (hash === FLAG_HASH) {
          const section = document.getElementById("flagSection");
          resultEl.className = "flag-result correct";
          resultEl.innerHTML =
            '<span class="solved-badge flag-pop">\u2713 Correct!</span>';

          if (section) {
            section.classList.add("celebrate");
            _confetti.burst(section);
            setTimeout(() => section.classList.remove("celebrate"), 800);
          }

          _setSolved(SLUG);
          _updateStatus();
        } else {
          resultEl.className = "flag-result incorrect";
          resultEl.textContent = "Incorrect flag. Try again.";
          input.classList.add("shake");
          setTimeout(() => input.classList.remove("shake"), 400);
        }

        return false;
      }

      /* ── Hint toggle ── */
      function _toggleHint(header) {
        const body = header.nextElementSibling;
        const btn = header.querySelector(".hint-toggle");
        const isRevealed = body.classList.contains("revealed");

        if (!isRevealed) {
          if (!body.dataset.confirmed) {
            btn.textContent = "Sure?";
            body.dataset.confirmed = "pending";
            return;
          }
          if (body.dataset.confirmed === "pending") {
            btn.textContent = "Really sure?";
            body.dataset.confirmed = "confirm-again";
            return;
          }
          body.classList.add("revealed");
          btn.textContent = "Hide";
          body.dataset.confirmed = "done";
        } else {
          body.classList.remove("revealed");
          btn.textContent = "Reveal";
          delete body.dataset.confirmed;
        }
      }

      // Init
      _updateStatus();
    </script>
  </body>
</html>
