<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CTF Challenges</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link
      href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;700&family=Source+Serif+4:ital,wght@0,400;0,600;1,400&display=swap"
      rel="stylesheet"
    />
    <style>
      /* ── Shared base ── */
      {{SHARED_CSS}}

      /* ── Homepage-specific styles ── */
      .container {
        max-width: 720px;
        width: 100%;
      }

      .site-header {
        margin-bottom: 40px;
      }

      .site-tag {
        display: inline-block;
        font-family: "JetBrains Mono", monospace;
        font-size: 11px;
        font-weight: 700;
        letter-spacing: 2px;
        text-transform: uppercase;
        color: var(--accent);
        background: var(--accent-glow);
        padding: 4px 12px;
        border-radius: 3px;
        margin-bottom: 12px;
      }

      .subtitle {
        font-size: 17px;
        color: var(--text-dim);
      }

      .progress-bar {
        margin-top: 20px;
        background: var(--surface-2);
        border: 1px solid var(--border);
        border-radius: 6px;
        padding: 16px 20px;
        display: flex;
        align-items: center;
        gap: 16px;
      }

      .progress-track {
        flex: 1;
        height: 6px;
        background: var(--surface);
        border-radius: 3px;
        overflow: hidden;
      }

      .progress-fill {
        height: 100%;
        background: var(--green);
        border-radius: 3px;
        transition: width 0.4s ease;
      }

      .progress-label {
        font-family: "JetBrains Mono", monospace;
        font-size: 13px;
        color: var(--text-dim);
        white-space: nowrap;
      }

      /* Groups */
      .group {
        margin-bottom: 32px;
      }

      .group-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 16px 20px;
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: 8px;
        cursor: pointer;
        user-select: none;
        transition: border-color 0.2s, background 0.15s;
      }

      .group-header:hover {
        border-color: var(--accent);
        background: var(--surface-2);
      }

      .group-header-left {
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .group-chevron {
        font-size: 14px;
        color: var(--text-dim);
        transition: transform 0.25s ease;
        display: inline-block;
      }

      .group.collapsed .group-chevron {
        transform: rotate(-90deg);
      }

      .group-title {
        font-family: "JetBrains Mono", monospace;
        font-size: 18px;
        font-weight: 700;
        color: #f0f2f6;
        margin: 0;
      }

      .group-count {
        font-family: "JetBrains Mono", monospace;
        font-size: 11px;
        font-weight: 700;
        color: var(--text-dim);
        background: var(--surface-2);
        padding: 2px 8px;
        border-radius: 10px;
      }

      .group-progress {
        font-family: "JetBrains Mono", monospace;
        font-size: 11px;
        color: var(--text-dim);
      }

      .group-progress.all-solved {
        color: var(--green);
      }

      .group-description {
        font-size: 14px;
        color: var(--text-dim);
        padding: 12px 20px 0;
        line-height: 1.6;
      }

      .group-body {
        padding-top: 16px;
        overflow: hidden;
        transition: max-height 0.35s ease, opacity 0.25s ease, padding-top 0.35s ease;
        max-height: 5000px;
        opacity: 1;
      }

      .group.collapsed .group-body {
        max-height: 0;
        opacity: 0;
        padding-top: 0;
      }

      .group.collapsed .group-description {
        display: none;
      }

      /* Challenge cards */
      .challenge-card {
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 28px 32px;
        margin-bottom: 20px;
        transition: border-color 0.2s, box-shadow 0.2s;
      }

      .challenge-card:hover {
        border-color: var(--accent);
        box-shadow: 0 0 20px var(--accent-glow);
      }

      .challenge-card.solved {
        border-color: var(--green);
        box-shadow: 0 0 20px #22c55e22;
      }

      .card-header {
        display: flex;
        align-items: center;
        gap: 14px;
        margin-bottom: 12px;
      }

      .difficulty {
        flex-shrink: 0;
      }

      .card-title {
        font-family: "JetBrains Mono", monospace;
        font-size: 20px;
        font-weight: 700;
        color: #f0f2f6;
        text-decoration: none;
        transition: color 0.15s;
      }

      .card-title:hover {
        color: var(--accent);
      }

      .card-summary {
        font-size: 15px;
        color: var(--text-dim);
        margin-bottom: 20px;
        line-height: 1.6;
      }

      .card-footer {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        gap: 12px;
      }

      .card-link {
        font-family: "JetBrains Mono", monospace;
        font-size: 13px;
        color: var(--accent);
        text-decoration: none;
        transition: opacity 0.15s;
        margin-right: auto;
      }

      .card-link:hover {
        opacity: 0.8;
      }

      /* Flag form (homepage compact sizing) */
      .flag-input {
        padding: 7px 12px;
        width: 200px;
      }

      .flag-btn {
        font-size: 12px;
        padding: 8px 16px;
      }

      .flag-result {
        font-size: 12px;
        min-height: 18px;
        width: 100%;
        margin-top: 4px;
      }

      /* Reset button */
      .reset-section {
        margin-top: 40px;
        display: flex;
        justify-content: center;
      }

      .reset-btn {
        font-family: "JetBrains Mono", monospace;
        font-size: 11px;
        letter-spacing: 1px;
        text-transform: uppercase;
        color: var(--text-dim);
        background: none;
        border: 1px solid var(--border);
        border-radius: 4px;
        padding: 8px 20px;
        cursor: pointer;
        transition: color 0.2s, border-color 0.2s;
      }

      .reset-btn:hover {
        color: var(--red);
        border-color: var(--red);
      }

      /* Confirm dialog overlay */
      .confirm-overlay {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.7);
        backdrop-filter: blur(4px);
        z-index: 1000;
        justify-content: center;
        align-items: center;
      }

      .confirm-overlay.visible {
        display: flex;
      }

      .confirm-dialog {
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 32px;
        max-width: 400px;
        width: 90%;
        text-align: center;
      }

      .confirm-dialog h3 {
        font-family: "JetBrains Mono", monospace;
        font-size: 16px;
        color: #f0f2f6;
        margin-bottom: 12px;
      }

      .confirm-dialog p {
        font-size: 14px;
        color: var(--text-dim);
        margin-bottom: 24px;
      }

      .confirm-actions {
        display: flex;
        gap: 12px;
        justify-content: center;
      }

      .confirm-actions button {
        font-family: "JetBrains Mono", monospace;
        font-size: 12px;
        font-weight: 700;
        padding: 8px 20px;
        border-radius: 4px;
        cursor: pointer;
        border: none;
        transition: opacity 0.15s;
      }

      .confirm-actions button:hover {
        opacity: 0.85;
      }

      .btn-cancel {
        color: var(--text);
        background: var(--surface-2);
        border: 1px solid var(--border) !important;
      }

      .btn-danger {
        color: #fff;
        background: var(--red);
      }

      @media (max-width: 600px) {
        .card-footer { flex-direction: column; align-items: flex-start; }
        .flag-input { width: 100%; }
        .flag-form { width: 100%; }
      }
    </style>
  </head>
  <body>
    <canvas class="confetti-canvas" id="confettiCanvas"></canvas>

    <div class="container">
      <div class="site-header">
        <div class="site-tag">Capture the Flag</div>
        <h1>Challenges</h1>
        <p class="subtitle">
          {{COUNT}} challenge(s) available. Submit flags below to track your
          progress.
        </p>

        <div class="progress-bar">
          <span class="progress-label" id="progressText">0 / {{COUNT}} solved</span>
          <div class="progress-track">
            <div class="progress-fill" id="progressFill" style="width: 0%"></div>
          </div>
        </div>
      </div>

{{GROUPS}}

      <div class="reset-section">
        <button class="reset-btn" onclick="_showReset()">Reset Progress</button>
      </div>
    </div>

    <!-- Reset confirmation dialog -->
    <div class="confirm-overlay" id="resetOverlay" onclick="_hideReset(event)">
      <div class="confirm-dialog">
        <h3>Reset all progress?</h3>
        <p>
          This will clear all solved flags. You'll need to re-submit every flag
          to get them back.
        </p>
        <div class="confirm-actions">
          <button class="btn-cancel" onclick="_hideReset()">Cancel</button>
          <button class="btn-danger" onclick="_confirmReset()">Yes, reset</button>
        </div>
      </div>
    </div>

    <script>
      /* ── Shared helpers ── */
      {{SHARED_JS}}

      /* ── Homepage-specific logic ── */
      const FLAG_HASHES = {
{{HASHES}}
      };

      const GROUP_MAP = {
{{GROUP_MAP}}
      };

      const TOTAL = Object.keys(FLAG_HASHES).length;

      /* Group collapse */
      function _toggleGroup(header) {
        const group = header.closest(".group");
        group.classList.toggle("collapsed");
        _saveCollapseState();
      }

      function _saveCollapseState() {
        const state = {};
        document.querySelectorAll(".group").forEach(g => {
          state[g.dataset.group] = g.classList.contains("collapsed");
        });
        localStorage.setItem("ctf_collapsed", JSON.stringify(state));
      }

      function _restoreCollapseState() {
        try {
          const state = JSON.parse(localStorage.getItem("ctf_collapsed") || "{}");
          for (const [slug, collapsed] of Object.entries(state)) {
            if (collapsed) {
              const g = document.querySelector(`.group[data-group="${slug}"]`);
              if (g) g.classList.add("collapsed");
            }
          }
        } catch {}
      }

      /* Progress */
      function _updateProgress() {
        const solved = _getSolved();
        const count = Object.keys(FLAG_HASHES).filter(k => solved[k]).length;
        document.getElementById("progressText").textContent = count + " / " + TOTAL + " solved";
        document.getElementById("progressFill").style.width = (TOTAL ? (count / TOTAL) * 100 : 0) + "%";

        // Update card solved states
        for (const slug of Object.keys(FLAG_HASHES)) {
          const card = document.querySelector(`.challenge-card[data-slug="${slug}"]`);
          if (!card) continue;
          const resultEl = card.querySelector(".flag-result");
          if (solved[slug]) {
            card.classList.add("solved");
            if (resultEl && !resultEl.textContent) {
              resultEl.className = "flag-result correct";
              resultEl.innerHTML = '<span class="solved-badge flag-pop">&#10003; Solved</span>';
            }
          }
        }

        // Update per-group progress
        for (const [groupSlug, challenges] of Object.entries(GROUP_MAP)) {
          const el = document.querySelector(`[data-group-progress="${groupSlug}"]`);
          if (!el) continue;
          const groupSolved = challenges.filter(c => solved[c]).length;
          el.textContent = groupSolved + " / " + challenges.length;
          if (groupSolved === challenges.length && challenges.length > 0) {
            el.classList.add("all-solved");
            el.textContent += " ✓";
          } else {
            el.classList.remove("all-solved");
          }
        }
      }

      /* Flag checking */
      async function _checkFlag(e) {
        e.preventDefault();
        const form = e.target;
        const slug = form.dataset.slug;
        const input = form.querySelector(".flag-input");
        const resultEl = document.querySelector(`[data-result="${slug}"]`);
        const value = input.value.trim();

        if (!value) return false;

        const expected = FLAG_HASHES[slug];
        if (!expected) {
          resultEl.className = "flag-result incorrect";
          resultEl.textContent = "No hash configured for this challenge.";
          return false;
        }

        const hash = await _sha256(value);

        if (hash === expected) {
          const card = document.querySelector(`.challenge-card[data-slug="${slug}"]`);

          resultEl.className = "flag-result correct";
          resultEl.innerHTML = '<span class="solved-badge flag-pop">&#10003; Correct!</span>';

          if (card) {
            card.classList.add("solved", "celebrate");
            _confetti.burst(card);
            setTimeout(() => card.classList.remove("celebrate"), 800);
          }

          _setSolved(slug);
          _updateProgress();
        } else {
          resultEl.className = "flag-result incorrect";
          resultEl.textContent = "Incorrect flag. Try again.";
          input.classList.add("shake");
          setTimeout(() => input.classList.remove("shake"), 400);
        }

        return false;
      }

      /* Reset dialog */
      function _showReset() {
        document.getElementById("resetOverlay").classList.add("visible");
      }

      function _hideReset(e) {
        if (!e || e.target === document.getElementById("resetOverlay")) {
          document.getElementById("resetOverlay").classList.remove("visible");
        }
      }

      function _confirmReset() {
        localStorage.removeItem("ctf_solved");
        document.getElementById("resetOverlay").classList.remove("visible");

        document.querySelectorAll(".challenge-card").forEach(card => {
          card.classList.remove("solved", "celebrate");
          const resultEl = card.querySelector(".flag-result");
          if (resultEl) {
            resultEl.className = "flag-result";
            resultEl.textContent = "";
          }
        });

        _updateProgress();
      }

      // Init on load
      _restoreCollapseState();
      _updateProgress();
    </script>
  </body>
</html>
