<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Secret Management · Wiki · NimbusOps/status-dash — GitHub Enterprise Server</title>
    <link rel="stylesheet" href="ghes.css" />
    <link rel="icon" href="../favicon.ico" type="image/x-icon" />
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
      .wiki-layout { display: grid; grid-template-columns: 260px 1fr; gap: 24px; }
      .wiki-sidebar { border-right: 1px solid var(--ghes-border-subtle); padding-right: 20px; }
      .wiki-sidebar-title { font-size: 15px; font-weight: 600; color: var(--ghes-text); margin-bottom: 12px; }
      .wiki-page-list { list-style: none; }
      .wiki-page-list li { margin-bottom: 2px; }
      .wiki-page-list a { display: block; padding: 6px 10px; font-size: 13px; border-radius: 6px; color: var(--ghes-text-muted); text-decoration: none; }
      .wiki-page-list a:hover { background: var(--ghes-surface-hover); color: var(--ghes-text); }
      .wiki-page-list a.active { background: rgba(56,139,253,0.15); color: var(--ghes-link); font-weight: 600; }
      .wiki-content { min-width: 0; }
      .wiki-content h1 { font-size: 28px; font-weight: 600; margin-bottom: 8px; padding-bottom: 8px; border-bottom: 1px solid var(--ghes-border); }
      .wiki-content h2 { font-size: 20px; font-weight: 600; margin-top: 28px; margin-bottom: 12px; padding-bottom: 6px; border-bottom: 1px solid var(--ghes-border-subtle); }
      .wiki-content h3 { font-size: 16px; font-weight: 600; margin-top: 20px; margin-bottom: 8px; }
      .wiki-content p { font-size: 14px; line-height: 1.7; margin-bottom: 12px; color: var(--ghes-text); }
      .wiki-content ul, .wiki-content ol { margin: 8px 0 16px 20px; font-size: 14px; line-height: 1.7; }
      .wiki-content li { margin-bottom: 4px; }
      .wiki-content code { font-size: 13px; background: var(--ghes-btn-bg); padding: 2px 6px; border-radius: 4px; font-family: ui-monospace, monospace; }
      .wiki-content pre { background: var(--ghes-bg); border: 1px solid var(--ghes-border); border-radius: 6px; padding: 16px; margin: 12px 0; overflow-x: auto; font-size: 13px; font-family: ui-monospace, monospace; line-height: 1.5; }
      .wiki-content table { width: 100%; border-collapse: collapse; margin: 12px 0; font-size: 14px; }
      .wiki-content th, .wiki-content td { padding: 8px 12px; text-align: left; border: 1px solid var(--ghes-border); }
      .wiki-content th { background: var(--ghes-surface); font-weight: 600; }
      .wiki-meta { font-size: 12px; color: var(--ghes-text-subtle); margin-bottom: 20px; }
      .wiki-content .callout { background: rgba(56,139,253,0.1); border: 1px solid rgba(56,139,253,0.4); border-radius: 6px; padding: 12px 16px; margin: 12px 0; font-size: 14px; }
      .wiki-content .callout-warn { background: rgba(210,153,34,0.1); border-color: rgba(210,153,34,0.4); }
    </style>
  </head>
  <body>
    <header class="ghes-header">
      <div class="ghes-header-inner">
        <a class="ghes-logo" href="index.html">
          <svg height="32" viewBox="0 0 16 16" width="32"><path d="M8 0c4.42 0 8 3.58 8 8a8.013 8.013 0 0 1-5.45 7.59c-.4.08-.55-.17-.55-.38 0-.27.01-1.13.01-2.2 0-.75-.25-1.23-.54-1.48 1.78-.2 3.65-.88 3.65-3.95 0-.88-.31-1.59-.82-2.15.08-.2.36-1.02-.08-2.12 0 0-.67-.22-2.2.82-.64-.18-1.32-.27-2-.27-.68 0-1.36.09-2 .27-1.53-1.03-2.2-.82-2.2-.82-.44 1.1-.16 1.92-.08 2.12-.51.56-.82 1.28-.82 2.15 0 3.06 1.86 3.75 3.64 3.95-.23.2-.44.55-.51 1.07-.46.21-1.61.55-2.33-.66-.15-.24-.6-.83-1.23-.82-.67.01-.27.38.01.53.34.19.73.9.82 1.13.16.45.68 1.31 2.69.94 0 .67.01 1.3.01 1.49 0 .21-.15.45-.55.38A7.995 7.995 0 0 1 0 8c0-4.42 3.58-8 8-8Z" /></svg>
          <span class="ghes-enterprise-badge">Enterprise</span>
        </a>
        <div class="ghes-header-search"><input type="text" placeholder="Search or jump to…" /></div>
        <div class="ghes-header-right">
          <span class="ghes-header-icon"><i data-lucide="plus" width="16" height="16"></i></span>
          <span class="ghes-header-icon"><i data-lucide="bell" width="16" height="16"></i><span class="ghes-notification-dot"></span></span>
          <div class="ghes-avatar-dropdown"><div class="ghes-avatar">MS</div><i data-lucide="chevron-down" width="12" height="12"></i></div>
        </div>
      </div>
    </header>

    <div class="repo-header">
      <div class="repo-breadcrumb">
        <i data-lucide="book-open" width="16" height="16" style="color: #7d8590"></i>
        <a href="repo.html" class="repo-owner">NimbusOps</a>
        <span class="repo-separator">/</span>
        <a href="repo.html" class="repo-name">status-dash</a>
        <span class="repo-visibility">Internal</span>
      </div>
      <nav class="repo-tabs">
        <a class="repo-tab" href="repo.html"><i data-lucide="book-open" width="16" height="16"></i> Code</a>
        <a class="repo-tab" href="issues.html"><i data-lucide="circle-dot" width="16" height="16"></i> Issues <span class="counter">3</span></a>
        <a class="repo-tab" href="pulls.html"><i data-lucide="git-pull-request" width="16" height="16"></i> Pull requests <span class="counter">1</span></a>
        <a class="repo-tab" href="actions.html"><i data-lucide="play" width="16" height="16"></i> Actions</a>
        <a class="repo-tab" href="#"><i data-lucide="layout-grid" width="16" height="16"></i> Projects</a>
        <a class="repo-tab active" href="wiki.html"><i data-lucide="book-text" width="16" height="16"></i> Wiki</a>
        <a class="repo-tab" href="#"><i data-lucide="shield" width="16" height="16"></i> Security</a>
        <a class="repo-tab" href="#"><i data-lucide="settings" width="16" height="16"></i> Settings</a>
      </nav>
    </div>

    <div class="page-body">
      <div class="wiki-layout">
        <div class="wiki-sidebar">
          <div class="wiki-sidebar-title">Pages</div>
          <ul class="wiki-page-list">
            <li><a href="wiki.html">Home</a></li>
            <li><a href="wiki-runbook.html">On-Call Runbook</a></li>
            <li><a href="wiki-architecture.html">Architecture Overview</a></li>
            <li><a href="wiki-secrets.html" class="active">Secret Management</a></li>
            <li><a href="wiki-postmortem-nov.html">Postmortem: Nov 14 Outage</a></li>
          </ul>
        </div>
        <div class="wiki-content">
          <h1>Secret Management</h1>
          <div class="wiki-meta">Last edited by <strong style="color:var(--ghes-text);">msantiago</strong> 4 weeks ago · <a href="#">3 revisions</a></div>

          <p>This page documents how secrets are managed for the status-dash deploy pipeline.</p>

          <h2>Secrets Inventory</h2>
          <table>
            <tr><th>Secret Name</th><th>Purpose</th><th>Where Used</th><th>Owner</th></tr>
            <tr><td><code>DEPLOY_KEY</code></td><td>Authenticates to the container registry</td><td>deploy-prod.yml (Steps 3, 4)</td><td>@msantiago</td></tr>
            <tr><td><code>REGISTRY_TOKEN</code></td><td>Read-only access for CI pull (test base image)</td><td>build-test.yml</td><td>@msantiago</td></tr>
            <tr><td><code>SLACK_WEBHOOK</code></td><td>Deploy notifications to #infra</td><td>deploy-prod.yml (Step 8)</td><td>@jpark</td></tr>
            <tr><td><code>AWS_ACCESS_KEY_ID</code></td><td>ECR access for stale image cleanup</td><td>stale-cleanup.yml</td><td>@msantiago</td></tr>
            <tr><td><code>AWS_SECRET_ACCESS_KEY</code></td><td>ECR access for stale image cleanup</td><td>stale-cleanup.yml</td><td>@msantiago</td></tr>
          </table>

          <h2>How Secrets Are Protected</h2>

          <h3>Encrypted Storage</h3>
          <p>All secrets are stored using GitHub's encrypted secrets feature. They're encrypted at rest using a Libsodium sealed box (Curve25519 + XSalsa20-Poly1305). They can only be decrypted by the Actions runner during a workflow run.</p>

          <h3>Log Masking</h3>
          <p>GitHub Actions automatically masks secret values in log output. When the runner detects a registered secret value in stdout or stderr, it replaces it with <code>***</code>. This ensures secrets never appear in plain text in build logs.</p>

          <div class="callout">
            <strong>ℹ️ From the December 2024 security audit:</strong>
            <p style="margin-top:8px;margin-bottom:0;">"All pipeline secrets are stored using encrypted secret management and are automatically redacted in job output logs. A manual review of all historical build and deploy logs confirmed no instances of secret exposure. CI/CD secret handling is compliant with internal security policy."</p>
          </div>

          <h3>Access Control</h3>
          <ul>
            <li>Secrets are scoped to the repository — only workflows in <code>NimbusOps/status-dash</code> can access them</li>
            <li>Environment secrets require approval from a designated reviewer (Marina) for production deploys</li>
            <li>Only repo admins (Marina, James) can create or update secret values</li>
            <li>Fork PRs cannot access secrets (GHES default policy)</li>
          </ul>

          <h2>Deploy Key Details</h2>
          <p>The <code>DEPLOY_KEY</code> is the most critical secret. It provides <strong>read/write access to every image</strong> in the NimbusOps container registry. Anyone with this key could:</p>
          <ul>
            <li>Pull any container image (including internal tools, backend services, etc.)</li>
            <li>Push malicious images that could be deployed to production</li>
            <li>Overwrite existing image tags</li>
          </ul>

          <h3>How It's Used in the Pipeline</h3>
          <ol>
            <li>Step 3 validates the key exists and has the expected format (28 chars)</li>
            <li>Step 4 constructs the full auth string (<code>flag{DEPLOY_KEY}</code>), base64-encodes it, and writes it to <code>/tmp/.registry-auth</code></li>
            <li>Step 4 then uses the encoded value as a <code>Basic</code> auth header to authenticate with the registry API</li>
          </ol>

          <div class="callout-warn callout">
            <strong>⚠️ Note:</strong> The auth file (<code>/tmp/.registry-auth</code>) contains the base64-encoded deploy key. It's written only during the workflow run and exists only on the ephemeral runner filesystem. The runner is destroyed after the job completes.
          </div>

          <h2>Rotation Policy</h2>
          <ul>
            <li><strong>DEPLOY_KEY:</strong> Rotated annually, or immediately if compromise is suspected. Last rotated: October 2025.</li>
            <li><strong>REGISTRY_TOKEN:</strong> Rotated quarterly. Read-only scope.</li>
            <li><strong>SLACK_WEBHOOK:</strong> No scheduled rotation. Regenerate if the Slack workspace is reorganized.</li>
            <li><strong>AWS credentials:</strong> Rotated every 90 days via automated IAM key rotation.</li>
          </ul>

          <h2>Future: OIDC Migration</h2>
          <p>We're planning to migrate from the static <code>DEPLOY_KEY</code> to OIDC-based authentication (see <a href="issues.html">#65</a>). This would eliminate long-lived credentials entirely — the Actions runner would request a short-lived token from the registry's OIDC provider for each deploy. This is tracked in <code>NimbusOps/deploy-tools#89</code>.</p>
        </div>
      </div>
    </div>

    <footer class="ghes-footer">
      <div class="footer-links"><a href="#">Terms</a><a href="#">Privacy</a><a href="#">Security</a><a href="#">Status</a><a href="#">Docs</a></div>
      <span class="ghes-version">GitHub Enterprise Server 3.13.2</span>
    </footer>
    <script>lucide.createIcons();</script>
  </body>
</html>
