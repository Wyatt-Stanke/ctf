# Pipeline CTF — Compiler & Architecture Notes

## How the Compiler Works

The `compiler/` package is a small static-site toolchain with two modes:

### `compile` (builder.py)

Walks a source directory and copies every file into `dist/`, applying
**compiler directives** found on the first line of text files.  The
output is a flat, fully-rendered snapshot ready for deployment.

### `serve` (server.py)

Starts a threaded HTTP dev server that applies directives **on the fly**
for every request.  No build step needed — edit a source file and
reload the browser.

## Compiler Directives (directives.py)

Directives are single-line comments placed as the **very first line** of
a file.

| Directive | Syntax | Effect |
|-----------|--------|--------|
| `directory_listing` | `<!-- COMPILER: directory_listing -->` | Replaces the file with an nginx-style auto-index of sibling files. |
| `html_minify` | `<!-- COMPILER: html_minify -->` | Strips comments, collapses whitespace, minifies the HTML. |
| `json_minify` | `// COMPILER: json_minify` | Compact-serialises the JSON (removes whitespace). |
| `no_include` | `// COMPILER: no_include` | Excludes the file from build output **and** blocks it from being served. |
| `base64_bundle` | `// COMPILER: base64_bundle <file>` | Base64-encodes the referenced file and appends `eval(atob("..."));`. |

### Hidden Markdown Exclusion (`.*.md`)

Any file whose name matches the pattern `.*.md` (a leading dot, any
characters, ending in `.md`) is **automatically excluded** everywhere:

- **Builder:** skipped during `compile` — never copied to `dist/`.
- **Server:** returns 404 — cannot be fetched via HTTP.
- **Directory listings:** hidden from generated index pages.

This lets authors keep documentation (like this file) alongside the
challenge source without leaking it to players.

## Key Files for the CTF Pipeline Challenge

### `js/_ci-runner-src.js`

The **unobfuscated** source for the in-browser CI simulator.  Contains
the flag in plaintext.  Marked `// COMPILER: no_include` so it's
stripped from builds and blocked from the dev server.

The companion `js/ci-runner.js` uses the `base64_bundle` directive to
read `_ci-runner-src.js`, base64-encode it, and append
`eval(atob("..."))` — producing an "obfuscated" build artefact that
players *could* reverse but shouldn't need to.

### `_ghes/dispatch.html`

The interactive dispatch page that loads `ci-runner.js`.  When the
player submits the form with the right query parameters, the JS
simulates the GitHub Actions pipeline and reveals the base64-encoded
flag in the "failure debug" output.

### `.github/workflows/deploy-prod.yml`

The YAML workflow that players need to read to understand the exploit.
It documents:

- **`workflow_dispatch` inputs** (including the hidden
  `registry_override` and `skip_preflight`)
- The **auth-file write** in Step 4 (before the network call)
- The **debug dump** in Step 7 (`if: failure()`)

## Directory Structure Conventions

- `index.html` files with the `directory_listing` directive act as
  nginx-style auto-indexes for their parent directory.
- Paths prefixed with `_` (e.g. `_logs/`, `_ghes/`) are "internal"
  areas the player discovers through recon.
- The `challenge/` directory holds the briefing page with progressive
  hints.

## Full File Inventory

### `_ghes/` — Simulated GitHub Enterprise Server

| File | Purpose |
|------|---------|
| `index.html` | GHES dashboard (activity feed, repos sidebar) |
| `repo.html` | Repo page (file browser, README) |
| `actions.html` | Workflow run list |
| `dispatch.html` | Manual deploy form (loads ci-runner.js) |
| `issues.html` | Issue tracker (3 open, 7 closed) |
| `issue-55.html` | Issue #55 detail — "Are our secrets safe?" discussion |
| `pulls.html` | Pull request list (1 open, 8 merged) |
| `commits.html` | Commit history (Nov 2025 – Feb 2026) |
| `wiki.html` | Wiki home (team, links, workflows) |
| `wiki-runbook.html` | On-call runbook (troubleshooting) |
| `wiki-architecture.html` | Architecture overview with ASCII diagram |
| `wiki-secrets.html` | Secret management docs |
| `wiki-postmortem-nov.html` | Nov 14 outage postmortem |
| `ghes.css` | Shared dark-theme CSS (~900 lines) |

All GHES pages share consistent header/tab navigation.  Tabs for
Issues, Pull Requests, and Wiki are cross-linked across all pages.

### `_logs/` — Deploy Logs

| File | Purpose |
|------|---------|
| `latest.json` | Run index with id, status, actor, commit, message |
| `deploy-116.log` | Failed deploy (Jan 28 DNS outage) — debug dump shows empty auth file |
| `deploy-118.log` | Successful deploy (Feb 3) |
| `deploy-119.log` | Successful deploy (Feb 7) |
| `deploy-120.log` | Successful deploy — latest (Feb 9) |
| `index.html` | Directory listing directive |

### Other Notable Files

| File | Purpose |
|------|---------|
| `nginx.conf` | Nginx config for the Docker container (referenced by Dockerfile) |
| `Dockerfile` | Multi-stage build, copies nginx.conf and static site |
| `status.json` | Service status data (used by the dashboard) |
| `.env.example` | Placeholder env vars (DEPLOY_KEY, REGISTRY, etc.) |
