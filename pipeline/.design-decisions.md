# Pipeline CTF — Design Decisions

## Why This Vulnerability?

GitHub Actions secret masking is a **commonly misunderstood** security
boundary.  Many developers assume that adding a value to
`secrets.<name>` means it can never leak through logs.  In reality, the
masking engine is a simple find-and-replace on the exact literal string.
Any transformation — `base64`, `sha256`, `jq`, URL-encoding, even
wrapping the value in a longer string — produces an output that will
**not** be masked.

This is documented by GitHub but widely overlooked:

> *"GitHub automatically redacts the value of the secret as printed to
> the log, but you should avoid printing secrets to the log
> intentionally."*

The challenge turns this subtlety into a hands-on exercise.

## Simulating the Pipeline In-Browser

Rather than requiring players to run a real GitHub Actions instance, the
exploit is simulated entirely in JavaScript (`ci-runner.js`).

The unobfuscated source (`_ci-runner-src.js`) is excluded from builds
via `// COMPILER: no_include` and bundled into the served JS via
`base64_bundle`, producing an `eval(atob(...))` wrapper.  This makes
casual inspection harder without being truly secure — a deliberate
trade-off for a CTF.

Players who reverse-engineer the obfuscation get the flag too, but
that's an alternative path, not the intended one.

## Progressive Hint Design

The challenge page (`/challenge/`) offers three hints behind expandable
`<details>` elements, each narrowing focus:

1. **Recon hint:** check `robots.txt` and data files for hidden paths.
2. **Workflow hint:** the dispatch accepts more inputs than the UI shows.
3. **Bypass hint:** skip preflight to let the pipeline reach the auth
   step before it fails.

This ensures players who are stuck can self-service without having to
ask for help, while those who want the full discovery experience can
ignore the hints.

## Fake GHES Interface

The `/_ghes/` directory replicates the GitHub Enterprise Server UI with
enough fidelity to feel immersive.  Key pages:

- **Dashboard** (`index.html`) — activity feed, repos, announcements.
- **Repository** (`repo.html`) — file browser, README, contributors.
- **Actions** (`actions.html`) — workflow run history with statuses.
- **Dispatch** (`dispatch.html`) — the interactive trigger form.
- **Issues** (`issues.html`) — tracker with 3 open + 7 closed issues.
- **Issue #55** (`issue-55.html`) — full thread where akovacs asks
  "are our secrets safe in Actions logs?" and gets reassured by
  msantiago and jpark.  This is a **key narrative element**: the team's
  overconfidence about masking IS the vulnerability the player exploits.
- **Pull Requests** (`pulls.html`) — 1 open, 8 merged PRs telling the
  development story (initial page, CI/CD pipeline, dispatch, redesign,
  registry override, etc.).
- **Commits** (`commits.html`) — chronological commit history showing
  the repo's evolution from Nov 2025 through Feb 2026, including the
  failed deploy on Jan 28.
- **Wiki** (5 pages) — Home, On-Call Runbook, Architecture Overview,
  Secret Management, and Postmortem for the Nov 14 outage.

The Secret Management wiki page is particularly important for the
solving experience: it documents exactly how `DEPLOY_KEY` is
base64-encoded during deploys, quotes a security audit claiming
"no instances of secret exposure," and explains the auth flow in
detail.  A careful reader can piece together the exploit from this
page alone.

The postmortem explains *why* the status dashboard exists — it was
born during the Nov 14 load balancer outage when the team had no way
to communicate status.  This gives the challenge world a believable
origin story.

All pages share consistent cross-linked tab navigation.  The CSS
(`ghes.css`) is ~900 lines reproducing the dark GitHub theme.

## The `robots.txt` Breadcrumb

Including `/_logs/`, `/.github/`, and `/.env.example` in `robots.txt`
is a classic CTF pattern but also reflects real-world misconfiguration.
Many production sites inadvertently advertise sensitive paths through
their robots file.

## Deploy Logs as Breadcrumbs

Four deploy log files (`deploy-116.log` through `deploy-120.log`) add
realism and teach the player how the pipeline behaves:

- **deploy-116.log** (FAILED) — from the Jan 28 DNS outage.  The
  `if: failure()` debug step ran, but because the pipeline failed
  *before* the auth step (at pre-flight), the auth file wasn't written.
  The dump shows `(file not found)`.  This teaches the player:
  1. The debug dump DOES fire on failure.
  2. The auth file only exists if the pipeline gets past pre-flight.
  3. Therefore, `skip_preflight=true` is needed to reach Step 4.

- **deploy-118/119/120** (successful) — show normal output with
  secrets properly masked (`***`).  They demonstrate that under normal
  circumstances the masking works fine, reinforcing the subtlety of
  the vuln.

The enriched `latest.json` includes actor, commit SHA, and message for
each run, connecting the logs to the commit history and making the
timeline feel cohesive.

## nginx.conf

The `nginx.conf` file is referenced by the `Dockerfile` (`COPY
nginx.conf /etc/nginx/conf.d/default.conf`).  It configures a realistic
nginx server: security headers, gzip, healthcheck endpoint for
Kubernetes probes, stub_status for Prometheus, and a dotfile deny rule.
This is purely for immersion — it makes the deployment story complete.

## Three Characters

The challenge features three fictional team members whose personalities
emerge across issues, PRs, wiki edits, and commit messages:

- **Marina Santiago** (`msantiago`) — DevOps lead, incident commander,
  risk-dismissive ("the audit says we're fine").
- **James Park** (`jpark`) — Senior eng, wrote the pipeline, added the
  `registry_override`/`skip_preflight` inputs "just for migration
  testing."
- **Alex Kovacs** (`akovacs`) — Junior dev who asked the right
  question ("are our secrets safe?") in issue #55 but was talked down.

This dynamic is deliberate: the player is essentially validating the
concern that akovacs raised and the team dismissed.

## Coffee Roaster

The "Coffee Roaster" entry in `status.json` is a red herring / easter
egg.  It adds personality to the fictional company and gives observant
players a chuckle without affecting the solve path.
